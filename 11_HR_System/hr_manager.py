'''üß† Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Business Logic)
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö:
‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (SSO): ‡∏´‡∏±‡∏Å 5% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏ï‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 750 ‡∏ö‡∏≤‡∏ó)
‡∏†‡∏≤‡∏©‡∏µ (Tax): ‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡∏á‡πà‡∏≤‡∏¢‡πÜ
‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20,000 = ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ
‡πÄ‡∏Å‡∏¥‡∏ô 20,000 = ‡∏´‡∏±‡∏Å 3%
‡πÄ‡∏Å‡∏¥‡∏ô 50,000 = ‡∏´‡∏±‡∏Å 5% (‡∏Ñ‡∏ô‡∏£‡∏ß‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞‡∏´‡∏ô‡πà‡∏≠‡∏¢)
‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Salary): ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° - ‡∏†‡∏≤‡∏©‡∏µ'''

import os


script_dir = os.path.dirname(__file__)
filename = os.path.join(script_dir, 'employees.txt')

def load_employees():
    '''‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'''
    employees = []
    if os.path.exists(filename):
        with open(filename, encoding='utf-8') as f:
            for line in f:
                parts = line.strip().split(',')
                employees.append(parts)
    return employees

def save_employees(employees:list):
    '''‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô list ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô file'''
    with open(filename, 'w', encoding='utf-8') as f:
        for item in employees:
            line = ','.join(item)
            f.write(line + '\n')
    print('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!')

def add_employee(employees:list):
    print('\n --- ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ---')
    emp_id = input('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (EMP01): ').strip().upper()

    for item in employees:
        if item[0] == emp_id:
            print('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß')
            return

    name = input('‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: ').strip()

    while True:
        sarary_str = input('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó): ').strip()
        if sarary_str.isdigit():
            break
        print('‚ùå ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!')
    
    position = input('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô: ').strip()

    # ‡πÄ‡∏Å‡πá‡∏ö List (salary ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô str ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ save ‡∏á‡πà‡∏≤‡∏¢)
    employees.append([emp_id, name, sarary_str, position])
    save_employees(employees)
    print(f'‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {name} ‡∏™‡∏π‡πà‡∏ó‡∏µ‡∏°')

def delete_employee(employees:list):
    print('\n---üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---')
    target_id = input('‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö: ').strip().upper()

    found = False
    for item in employees:
        if item[0] == target_id:
            print(f'‡πÄ‡∏à‡∏≠‡∏Ñ‡∏∏‡∏ì: {item[1]} (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: {item[3]})')
            confirm = input('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (y/n): ').lower()
            if confirm == 'y':
                employees.remove(item)
                found = True
                print('‚úÖ ‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')
                break
            else:
                return
    
    if found:
        save_employees(employees)
    else:
        print('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ')

def show_all_employees(employees:list):
    print('\n' + '='*70)
    print(f"{'ID':<8} {'‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•':<25} {'‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á':<15} {'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô':10}")
    print('='*70)
    for item in employees:
        salary_fmt = f"{int(item[2]):,}"
        print(f"{item[0]:<8} {item[1]:<25} {item[3]} {salary_fmt:>10}")
    print('='*70)

def calculate_and_show_slip(employees:list):
    '''function ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏•‡∏¥‡∏õ)'''
    print('\n--- üí∏ ‡∏≠‡∏≠‡∏Å‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---')
    target_id = input('‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ').strip().upper()

    found = False
    for item in employees:
        if item[0] == target_id:
            found = True
            name = item[1]
            salary = int(item[2])   # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            position = item[3]

            # --- üß† Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---

            # 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏ô 5% (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 750)
            sso = salary * 0.05
            if sso > 750:
                sso = 750
            
            # --- ‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡πÉ‡∏´‡πâ‡∏õ‡πã‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î ---
            print(f'\n‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì {name} (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {salary:,})')
            print('[1] ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢ 3-5%)')
            print('[2] ‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á (‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î + ‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô)')
            mode = input('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: ').strip()

            # 2. ‡∏†‡∏≤‡∏©‡∏µ (Step Tax)
            tax = 0
            if mode == '2':
                # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ def real world
                tax = calculate_tax_real_world(salary, sso)
                print('--> ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£ (‡∏Ç‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î)')
            else:
                if salary > 50000:
                    tax = salary * 0.05     # 5%
                elif salary > 20000:
                    tax = salary * 0.03     # 3%
                print('--> ‡πÉ‡∏Ç‡πâ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢')            
            
            # 3. ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏∏‡∏ó‡∏ò‡∏¥
            net_salary = salary - sso - tax

            # --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ---
            print('\n' + '*'*40)
            print(f'üìÑ SLIP ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {name} ({position})')
            print('*'*40)
            print(f'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: {salary:>10,} ‡∏ö‡∏≤‡∏ó')
            print(f'‚ûñ ‡∏´‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°: {sso:>10,.2f} ‡∏ö‡∏≤‡∏ó')
            print(f'‚ûñ ‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢: {tax:>10,.2f} ‡∏ö‡∏≤‡∏ó')
            print('-' * 40)
            print(f'üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: {net_salary:>10,.2f} ‡∏ö‡∏≤‡∏ó')
            print('-' * 40)
            break

    if not found:
        print('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ')

def calculate_tax_real_world(salary, sso_monthly):
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î (‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á)
    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    """
    # 1. ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ
    year_salary = salary * 12
    sso_year = sso_monthly * 12

    # 2. ‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (50% ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100,000)
    expense = year_salary * 0.5
    if expense > 100000:
        expense = 100000

    # 3. ‡∏´‡∏±‡∏Å‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (60,000)
    perssonal = 60000

    # 4. ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Income)
    net_income = year_salary - expense - perssonal - sso_year

    # 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î
    tax_year = 0

    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 150,000 = ‡∏ü‡∏£‡∏µ‡∏†‡∏≤‡∏©‡∏µ
    if net_income <= 150000:
        return 0
    
    # ‡∏ï‡∏±‡∏î 150,000 ‡πÅ‡∏£‡∏Å‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ü‡∏£‡∏µ)
    remain = net_income - 150000

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: 150,001 - 300,000 (‡∏Ñ‡∏¥‡∏î 5%) -> ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á 150,000
    step1 = 150000
    if remain < 150000:
        step1 = remain
    
    tax_year += step1 * 0.05
    remain -= step1

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: 300,001 - 500,000 (‡∏Ñ‡∏¥‡∏î 10%) -> ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á 200,000
    if remain > 0:
        step2 = 200000
        if remain < 200000:
            step2 = remain

        tax_year  += step2 * 0.10
        remain -= step2
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3: 500,001 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏¥‡∏î 15% ‡∏¢‡∏≤‡∏ß‡πÜ)
    if remain > 0:
        tax_year += remain * 0.15
    
    # ‡∏´‡∏≤‡∏£ 12 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    return tax_year / 12